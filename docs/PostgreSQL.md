
# PostgreSQL

## Ізоляція транзакцій

PostgreSQL працює за замовчуванням з рівнем **Read Committed** (навіть якщо доступний режим **Read Uncommitted**).

|                 | Втрачені зміни | Брудне читання | Неповторюване читання | Фантомне читання | Інші аномалії |
| --------------- | :------------: | :------------: | :-------------------: | :--------------: | :-----------: |
| Read Commited   |       -        |       -        |          так          |       так        |      так      |
| Repeatable Read |       -        |       -        |           -           |       так        |      так      |
| Serializable    |       -        |       -        |           -           |        -         |       -       |

## Нерегламентовані стандартом аномалії

| Вирішує                                                   | Аномалія                                                                                                                             | Опис                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Використання **ОДНОГО оператора** або **Repeatable Read** | Read Skew / неузгоджене читання<br><br>_(спричиняє помилку серілазації, треба робити ретраї)_                                        | Виникає при агрегації на декількох рядках, коли частина з них оновлена, а частина – ні. <br><br>**Приклад:** `SELECT SUM(amount) FROM accounts WHERE client = 'bob'`.<br><br>**Рішення:** використати один SQL-запит без вкладених запитів або забезпечити функцію як незмінну (NOT VOLATILE).                                                                                                                                                                                                                           |
| **Serializable**                                          | Write Skew / неузгоджений запис<br><br>_(спричиняє помилку серілазації, треба робити ретраї)_                                        | Виникає, коли дві транзакції роблять перевірку і змінюють різні частини даних на основі цієї перевірки, призводячи до неконсистентності.<br><br>**Приклад**: Дві транзакції перевіряють, що кількість записів у таблиці < 10, і якщо це так, додають новий запис. Якщо обидві транзакції одночасно зроблять цю перевірку, вони обидві додадуть нові записи, перевищуючи ліміт .                                                                                                                                          |
| **Serializable**                                          | Аномалія тільки читаючої транзакції<br><br>_(спричиняє помилку серілазації, у разі не використання **READ ONLY** та **DEFERRABLE**)_ | Виникає, коли транзакція читає незмінні дані, але бачить неконсистентні результати через паралельні зміни.<br><br>**Приклад**: Транзакція A читає значення X і Y, де обидва повинні бути або до, або після змін, зроблених іншою транзакцією B. Але якщо транзакція A читає X до змін, а Y після змін, це призводить до неконсистентності .<br><br>**_Рішення:_** _використання **SERIALIZABLE, READ ONLY** та **DEFERRABLE** модифікаторів для транзакції: **BEGIN ISOLATION LEVEL SERIALIZABLE READ ONLY DEFERRABLE**_ |

## Блокування

PostgreSQL за замовчуванням використовує **версіонування знімків** замість традиційного блокування, що підвищує продуктивність.

Для ручного блокування:
- Таблиця: `LOCK TABLE ...;`
- Рядки: `SELECT ... FOR UPDATE;`

Матриця конфліктів блокувань:

|               | Key Share | Share | No Key Update | Update |
| ------------- | :-------: | :---: | :-----------: | :----: |
| Key Share     |           |       |               |   X    |
| Share         |           |       |       X       |   X    |
| No Key Update |           |   X   |       X       |   X    |
| Update        |     X     |   X   |       X       |   X    |


*Приклад:*

```sql
-- Перша транзакція:
SELECT * FROM accounts WHERE id = 1 FOR SHARE;

-- Друга транзакція не зможе оновити цей рядок, оскільки режими Share та No Key Update несумісні.
```

Приклад з NOWAIT:

```sql
SELECT * FROM accounts FOR UPDATE NOWAIT;
-- ERROR: could not obtain lock on row in relation "accounts"
```

Приклад з SKIP LOCKED:

```sql
SELECT * FROM accounts ORDER BY id FOR UPDATE SKIP LOCKED LIMIT 1;
```

## Двигун зберігання

Можна змінити двигун зберігання даних за допомогою:

```sql
CREATE TABLE ... USING ...;
ALTER TABLE ... SET ACCESS METHOD ...;  -- зміна двигуна
```

За замовчуванням використовується двигун, вказаний у параметрі `default_table_access_method`.

## Види індексів

**Переваги:** швидкий пошук, зменшення часу виконання запитів.  
**Недоліки:** збільшення часу операцій вставки/оновлення/видалення, додаткове використання простору.

### Основні типи індексів

1. **B-Tree**  
   - Синтаксис: `btree(<column>)`  
   - Опис: універсальний для порівнянь (`=`, `<`, `<=`, `>`, `>=`), зберігає дані впорядковано.

2. **Hash**  
   - Синтаксис: `hash(<column>)`  
   - Опис: ефективний для точних порівнянь (`=`); подібний до механізму HashMap.

3. **GiST**  
   - Синтаксис: `gist(<column>)`  
   - Опис: підтримує геометричні, порядкові та діапазонні дані, використовується для повнотекстового пошуку, масивів тощо.

4. **SP-GiST**  
   - Синтаксис: `spgist(<column>)`  
   - Опис: оптимізований для розріджених даних.  
   *Приклади:*  
   - QuadTree:  
     ```sql
     CREATE INDEX airports_kd_idx ON airports_big USING spgist(coordinates);
     ```
   - K-Tree:  
     ```sql
     CREATE INDEX airports_kd_idx ON airports_big USING spgist(coordinates kd_point_ops);
     ```
   - Префіксне дерево:  
     ```sql
     CREATE INDEX airports_kd_idx ON airports_big USING spgist(coordinates text_ops);
     ```

5. **GIN**  
   - Синтаксис: `gin(<column>)`  
   - Опис: швидкий пошук за ключовими словами, підходить для індексації масивів.

6. **BRIN**  
   - Синтаксис: `brin(<column>)`  
   - Опис: ефективний для великих, впорядкованих таблиць (наприклад, за часом), особливо при 100,000+ записах.

### Оптимізація індексів

- Використання індексів на часто використовуваних стовпцях (`WHERE`, `JOIN`, `ORDER BY`).
- У разі кластерних індексів – використання підзапиту з діапазоном (мін/макс) для повторного використання індексу.
- Індекси з вбудованими даними для швидкого доступу без прямого звернення до таблиці:

  ```sql
  CREATE INDEX idx_users_email ON users(email) INCLUDE (created_at, last_login);
  ```

- Часткові індекси для зменшення їхнього розміру:

  ```sql
  CREATE INDEX idx_active_users ON users(email) WHERE active = true;
  ```

- Використання команд `ANALYZE` та `REINDEX` для підтримки продуктивності.